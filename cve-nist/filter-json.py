import json
import os
import sys

def process_cve(item, directory_year, directory_thousand):
    cve_details = json.dumps(item, indent=4)

    if not os.path.exists(directory_year):
        os.makedirs(directory_year)

    if not os.path.exists(directory_thousand):
        os.makedirs(directory_thousand)

    file_path = os.path.join(directory_thousand, f'{cve_id}.json')
    with open(file_path, 'w') as file:
        file.write(cve_details)

if len(sys.argv) < 2:
    print("Usage: python3 filter-json.py <path_to_json_file>")
    sys.exit(1)

json_file_path = sys.argv[1]

with open(json_file_path, 'r') as file:
    data = json.load(file)

# Déterminer la clé principale et la structure
if 'CVE_Items' in data:
    cve_items_key = 'CVE_Items'
    cve_id_key_path = ['cve', 'CVE_data_meta', 'ID']
elif 'cve_items' in data:
    cve_items_key = 'cve_items'
    cve_id_key_path = ['id']
else:
    print("Format de fichier JSON inconnu.")
    sys.exit(1)

# Itérer sur chaque élément CVE
for item in data[cve_items_key]:
    cve_id = item
    for key in cve_id_key_path:
        cve_id = cve_id[key]
    cve_year = cve_id.split('-')[1]
    cve_number = int(cve_id.split('-')[2])
    cve_thousand = cve_number // 1000

    directory_year = f'./{cve_year}'
    directory_thousand = f'{directory_year}/{cve_thousand}xxx'

    process_cve(item, directory_year, directory_thousand)

print(f"Fichiers créés avec succès pour le fichier {os.path.basename(json_file_path)}.")
